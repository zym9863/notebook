name: Build and Release

on:
  push:
    tags:
      - 'v*'  # åªåœ¨æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build APK with ABI split
        run: flutter build apk --release --split-per-abi

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 5

  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Windows app
        run: flutter build windows --release

      - name: Create Windows installer (optional)
        shell: powershell
        run: |
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„å‹ç¼©åŒ…
          $sourceDir = "build\windows\x64\runner\Release"
          $outputDir = "build\windows"
          $appName = "notebook-windows-x64"
          
          # å‹ç¼©æ–‡ä»¶
          Compress-Archive -Path "$sourceDir\*" -DestinationPath "$outputDir\$appName.zip" -Force
          
          # é‡å‘½åexeæ–‡ä»¶ä»¥ä¾¿è¯†åˆ«
          Copy-Item "$sourceDir\notebook.exe" -Destination "$outputDir\notebook-windows-x64.exe"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: |
            build/windows/notebook-windows-x64.exe
            build/windows/notebook-windows-x64.zip
          retention-days: 5

  release:
    name: Create Release
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apks
          path: ./artifacts/android/

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: ./artifacts/windows/

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: List artifacts
        run: |
          echo "Android APKs:"
          ls -la ./artifacts/android/
          echo "Windows files:"
          ls -la ./artifacts/windows/

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: Notebook ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸ“± Notebook App ${{ steps.get_version.outputs.VERSION }}
            
            ### ğŸš€ æ–°åŠŸèƒ½å’Œæ”¹è¿›
            - è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
            - æ”¯æŒå¤šå¹³å°éƒ¨ç½²
            
            ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶è¯´æ˜
            
            **Android APK æ–‡ä»¶ï¼š**
            - `app-arm64-v8a-release.apk` - é€‚ç”¨äº ARM64 è®¾å¤‡ï¼ˆæ¨èï¼Œå¤§å¤šæ•°ç°ä»£ Android è®¾å¤‡ï¼‰
            - `app-armeabi-v7a-release.apk` - é€‚ç”¨äº ARMv7 è®¾å¤‡ï¼ˆè¾ƒè€çš„ Android è®¾å¤‡ï¼‰
            - `app-x86_64-release.apk` - é€‚ç”¨äº x86_64 è®¾å¤‡ï¼ˆæ¨¡æ‹Ÿå™¨æˆ– x86 Android è®¾å¤‡ï¼‰
            
            **Windows æ–‡ä»¶ï¼š**
            - `notebook-windows-x64.exe` - Windows å¯æ‰§è¡Œæ–‡ä»¶
            - `notebook-windows-x64.zip` - Windows å®Œæ•´åº”ç”¨åŒ…ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–æ–‡ä»¶ï¼‰
            
            ### ğŸ“± å®‰è£…è¯´æ˜
            
            **Androidï¼š**
            1. ä¸‹è½½å¯¹åº”ä½ è®¾å¤‡æ¶æ„çš„ APK æ–‡ä»¶
            2. åœ¨è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
            3. ç‚¹å‡» APK æ–‡ä»¶å®‰è£…
            
            **Windowsï¼š**
            1. ä¸‹è½½ `notebook-windows-x64.zip` å¹¶è§£å‹
            2. è¿è¡Œè§£å‹åçš„ `notebook.exe`
            
            æˆ–è€…ç›´æ¥ä¸‹è½½ `notebook-windows-x64.exe` è¿è¡Œï¼ˆå¯èƒ½éœ€è¦å®‰è£… Visual C++ è¿è¡Œåº“ï¼‰
          draft: false
          prerelease: false

      - name: Upload Android APK (ARM64)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/android/app-arm64-v8a-release.apk
          asset_name: notebook-android-arm64-v8a.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload Android APK (ARMv7)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/android/app-armeabi-v7a-release.apk
          asset_name: notebook-android-armeabi-v7a.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload Android APK (x86_64)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/android/app-x86_64-release.apk
          asset_name: notebook-android-x86_64.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload Windows EXE
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/windows/notebook-windows-x64.exe
          asset_name: notebook-windows-x64.exe
          asset_content_type: application/octet-stream

      - name: Upload Windows ZIP
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/windows/notebook-windows-x64.zip
          asset_name: notebook-windows-x64.zip
          asset_content_type: application/zip
